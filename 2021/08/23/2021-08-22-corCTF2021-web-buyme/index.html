<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>corCTF 2021 web/buyme writeup | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="(Web) web&#x2F;buyme [444 pts] 이 문제는 flag를 구매하는 함수의 로직이 잘못된 부분을 이용하여 해결하는 문제입니다.  const fs &#x3D; require(&quot;fs&quot;);  const flags &#x3D; new Map(); for(let flag of JSON.parse(fs.readFileSync(&quot;flags.json&amp;q">
<meta property="og:type" content="article">
<meta property="og:title" content="corCTF 2021 web&#x2F;buyme writeup">
<meta property="og:url" content="http://example.com/2021/08/23/2021-08-22-corCTF2021-web-buyme/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="(Web) web&#x2F;buyme [444 pts] 이 문제는 flag를 구매하는 함수의 로직이 잘못된 부분을 이용하여 해결하는 문제입니다.  const fs &#x3D; require(&quot;fs&quot;);  const flags &#x3D; new Map(); for(let flag of JSON.parse(fs.readFileSync(&quot;flags.json&amp;q">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/82700218/130357942-b38052f8-62d6-4d5d-8709-bcee020ac669.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/82700218/130357998-7588bb6c-6660-49c7-98d9-d0d88c265663.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/82700218/130358810-219a8b7b-dc07-49be-99fa-4c06f26b16f5.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/82700218/130358918-2cf88f10-3c81-4da8-b1f5-df0f0799105e.png">
<meta property="article:published_time" content="2021-08-23T00:00:00.000Z">
<meta property="article:modified_time" content="2021-08-25T14:25:11.816Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/82700218/130357942-b38052f8-62d6-4d5d-8709-bcee020ac669.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-2021-08-22-corCTF2021-web-buyme" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/08/23/2021-08-22-corCTF2021-web-buyme/" class="article-date">
  <time class="dt-published" datetime="2021-08-23T00:00:00.000Z" itemprop="datePublished">2021-08-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      corCTF 2021 web/buyme writeup
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Web-web-buyme-444-pts"><a href="#Web-web-buyme-444-pts" class="headerlink" title="(Web) web/buyme [444 pts]"></a>(Web) web/buyme [444 pts]</h2><blockquote>
<p>이 문제는 flag를 구매하는 함수의 로직이 잘못된 부분을 이용하여 해결하는 문제입니다.</p>
</blockquote>
<pre><code class="js">const fs = require(&quot;fs&quot;);

const flags = new Map();
for(let flag of JSON.parse(fs.readFileSync(&quot;flags.json&quot;)).flags) &#123;
    if(flag.name === &quot;corCTF&quot;) &#123;
        flag.text = process.env.FLAG || &quot;corctf&#123;test_flag&#125;&quot;;
    &#125;
    flags.set(flag.name, flag);
&#125;

const users = new Map();

const buyFlag = (&#123; flag, user &#125;) =&gt; &#123;
    if(!flags.has(flag)) &#123;
        throw new Error(&quot;Unknown flag&quot;);
    &#125;
    if(user.money &lt; flags.get(flag).price) &#123;
        throw new Error(&quot;Not enough money&quot;);
    &#125;

    user.money -= flags.get(flag).price;
    user.flags.push(flag);
    users.set(user.user, user);
&#125;;

module.exports = &#123; flags, users, buyFlag &#125;;
</code></pre>
<p>위 코드를 보면 Map() 클래스를 사용하여 users라는 객체를 생성합니다.</p>
<p>그리고 <code>buyFlag()</code>함수를 보면 <code>has()</code> 메소드를 사용해 <code>flags</code>라는 객체에 인자로 넘어온 <code>flag</code>가 존재하는지 확인합니다. 만약 <code>flag</code>가 존재한다면 인자로 넘어온 <code>user</code>객체의 <code>money</code>값이 <code>flags</code>의 값과 비교하여 적으면 Error를 반환하고 많으면 <code>flag</code>의 가격만큼 돈을 깎고 <code>user.flag</code>에 <code>flag</code>를 push하고 <code>users</code>객체를 덮어쓰는걸 확인할 수 있습니다.</p>
<p>정상적인 로직이라면 사용자가 가진 돈을 사용자의 입력값에서 가져오는 것이 아니라 <code>db</code>를 참조해서 가져와야 하는데, <code>buyflag()</code> 함수에서는 사용자가 입력한 데이터를 참조하기 때문에 <code>user</code>데이터를 조작해서 보낸다면 flag를 획득할 수 있습니다.</p>
<p><img src="https://user-images.githubusercontent.com/82700218/130357942-b38052f8-62d6-4d5d-8709-bcee020ac669.png" alt="image"></p>
<p>회원가입 후 로그인을 하면 현재 가진 돈과 플래그가 나타납니다.</p>
<p><img src="https://user-images.githubusercontent.com/82700218/130357998-7588bb6c-6660-49c7-98d9-d0d88c265663.png" alt="image"></p>
<p><code>Flags</code>의 카테고리로 이동하면 구매할 수 있는 플래그들이 존재합니다. 구매해야할 플래그는 <code>corCTF</code>인데 가진 금액이 모자라 서 정상적으로는 구매가 불가능합니다.</p>
<pre><code class="js">router.post(&quot;/buy&quot;, requiresLogin, async (req, res) =&gt; &#123;
    if(!req.body.flag) &#123;
        return res.redirect(&quot;/flags?error=&quot; + encodeURIComponent(&quot;Missing flag to buy&quot;));
    &#125;

    try &#123;
        db.buyFlag(&#123; user: req.user, ...req.body &#125;);
    &#125;
    catch(err) &#123;
        return res.redirect(&quot;/flags?error=&quot; + encodeURIComponent(err.message));
    &#125;

    res.redirect(&quot;/?message=&quot; + encodeURIComponent(&quot;Flag bought successfully&quot;));
&#125;);
</code></pre>
<p><code>/buy</code> 라우터를 보면 <code>buyFlag()</code>함수를 호출할 때 첫 번째 인자로 <code>req.user</code>의 값을 그대로 넘겨주는 것을 확인할 수 있고,  두 번째 인자로 Spread syntax를 이용해 값을 넘겨주고 있습니다.</p>
<p><code>buyflag()</code>함수를 호출하기 전에 <code>req.user</code>에 대한 검증 절차가 존재하지 않아 자유롭게 조작이 가능합니다. 그래서 위에 분석한 <code>buyFlag()</code>함수의 잘못된 로직을 이용해 <code>json</code>으로 조작된 <code>user</code>의 데이터를 전달하여 플래그 구매를 시도 하였습니다.</p>
<p><strong>※</strong><code>json</code>으로 데이터를 전달해도 잘 동작하는 이유는 <code>app.use(express.json())</code>가 설정되어 있기 때문입니다.</p>
<p><img src="https://user-images.githubusercontent.com/82700218/130358810-219a8b7b-dc07-49be-99fa-4c06f26b16f5.png" alt="image"></p>
<p><code>response</code>를 통해 플래그 구매가 정상적으로 된것을 확인할 수 있습니다.</p>
<p><img src="https://user-images.githubusercontent.com/82700218/130358918-2cf88f10-3c81-4da8-b1f5-df0f0799105e.png" alt="image"></p>
<p>그리고 다시 <code>home</code>으로 돌아가보면 <code>flag</code>를 획득할 수 있습니다.</p>
<blockquote>
<p>FLAG : <code>corctf&#123;h0w_did_u_steal_my_flags_you_flag_h0arder??!!&#125;</code></p>
</blockquote>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/08/23/2021-08-22-corCTF2021-web-buyme/" data-id="cksrlakme0000uo19git63513" data-title="corCTF 2021 web/buyme writeup" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/08/25/hello-world/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Hello World
        
      </div>
    </a>
  
  
    <a href="/2021/05/24/index/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">About</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 10px;">CTF</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/08/25/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2021/08/23/2021-08-22-corCTF2021-web-buyme/">corCTF 2021 web/buyme writeup</a>
          </li>
        
          <li>
            <a href="/2021/05/24/index/">About</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>